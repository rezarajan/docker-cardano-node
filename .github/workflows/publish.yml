name: publish

# This workflow publishes pre-built images from ci-docker.yml
# Downloads digest artifacts from ci-docker.yml (images already in GHCR)
# Creates multi-arch manifests and copies/retags to Docker Hub + GHCR with proper tags

################################################################################
# CONFIGURATION FOR FORKS
################################################################################
#
# This workflow is designed to be fork-friendly. Follow these steps to configure
# your forked repository:
#
# 1. REQUIRED: Set up Docker Hub credentials
#    Go to: Settings > Secrets and variables > Actions > Secrets
#    Add the following Repository Secrets:
#    
#    DOCKER_PASSWORD (REQUIRED)
#      - Your Docker Hub personal access token
#      - Create at: https://hub.docker.com/settings/security
#      - Permissions: Read & Write
#    
#    DOCKER_USERNAME (OPTIONAL)
#      - Your Docker Hub username
#      - If not set, defaults to 'blinklabs'
#      - Only set this if publishing to your own Docker Hub account
#
# 2. OPTIONAL: Customize image names
#    Go to: Settings > Secrets and variables > Actions > Variables
#    Add the following Repository Variables (only if needed):
#    
#    DOCKER_IMAGE_NAME (OPTIONAL)
#      - Docker Hub image name (e.g., yourname/cardano-node)
#      - If not set, defaults to: blinklabs/cardano-node
#    
#    GHCR_IMAGE_NAME (OPTIONAL)
#      - GitHub Container Registry image name
#      - If not set, defaults to: ghcr.io/YOUR_USERNAME/cardano-node
#      - Example: ghcr.io/myorg/cardano-node
#
# 3. OPTIONAL: Disable main branch publishing (conserve resources)
#    Go to: Settings > Secrets and variables > Actions > Variables
#    Add the following Repository Variable:
#    
#    ENABLE_UPSTREAM_MAIN_PUBLISH
#      - Set to: false
#      - Effect: Skips publishing on main branch pushes
#      - Note: Tags will STILL be published (conserves resources for forks)
#      - Leave unset or set to 'true' to publish on all events
#
# 4. AUTOMATIC: GitHub Container Registry (GHCR)
#    - GITHUB_TOKEN is automatically provided by GitHub Actions
#    - No additional configuration needed
#    - Images will be published to: ghcr.io/YOUR_USERNAME/cardano-node
#
# 5. Repository Permissions
#    Go to: Settings > Actions > General > Workflow permissions
#    Ensure: "Read and write permissions" is selected
#    This allows the workflow to push to GHCR
#
################################################################################
# SUMMARY OF GITHUB SETTINGS NEEDED:
################################################################################
#
# Repository Secrets (Settings > Secrets and variables > Actions > Secrets):
#   ✓ DOCKER_PASSWORD        (REQUIRED - Docker Hub token)
#   ○ DOCKER_USERNAME        (OPTIONAL - defaults to 'blinklabs')
#
# Repository Variables (Settings > Secrets and variables > Actions > Variables):
#   ○ DOCKER_IMAGE_NAME              (OPTIONAL - defaults to blinklabs/cardano-node)
#   ○ GHCR_IMAGE_NAME                (OPTIONAL - defaults to ghcr.io/{owner}/cardano-node)
#   ○ ENABLE_UPSTREAM_MAIN_PUBLISH   (OPTIONAL - set to 'false' to skip main branch)
#
# Workflow Permissions (Settings > Actions > General):
#   ✓ Read and write permissions (for GHCR push)
#
################################################################################

on:
  workflow_run:
    workflows: ["Docker CI"]
    types:
      - completed
    # IMPORTANT: workflow_run requires specifying branches OR no filter at all
    # Without branches, it triggers for ALL branch/tag refs where the workflow runs
    # We filter specific events in check-ci-success job instead

# Use workflow_run's github.event.workflow_run.id for concurrency
# This ensures we don't have concurrent publishes for the same CI run
concurrency:
  group: publish-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

env:
  # Image names - these can be customized via Repository Variables
  # To customize: Settings > Secrets and variables > Actions > Variables
  DOCKER_IMAGE_NAME: ${{ vars.DOCKER_IMAGE_NAME || 'blinklabs/cardano-node' }}
  GHCR_IMAGE_NAME: ${{ vars.GHCR_IMAGE_NAME || format('ghcr.io/{0}/cardano-node', github.repository_owner) }}
  
  # Docker Hub username - configured via Repository Secrets
  # To customize: Settings > Secrets and variables > Actions > Secrets > DOCKER_USERNAME
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME || 'blinklabs' }}
  
  # Fork control - set via Repository Variables to skip main branch publishes
  # To enable: Settings > Secrets and variables > Actions > Variables > ENABLE_UPSTREAM_MAIN_PUBLISH = false
  ENABLE_UPSTREAM_MAIN_PUBLISH: ${{ vars.ENABLE_UPSTREAM_MAIN_PUBLISH != 'false' }}

jobs:
  # Always runs when triggered, checks CI success and publish criteria
  check-ci-success:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
    steps:
      - name: Check if should publish
        id: check
        run: |
          echo "=== Workflow Run Information ==="
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Event: ${{ github.event.workflow_run.event }}"
          echo "Head branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Head SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "Repository: ${{ github.event.workflow_run.repository.full_name }}"
          echo "==============================="
          
          # Check if CI workflow succeeded
          if [[ "${{ github.event.workflow_run.conclusion }}" != "success" ]]; then
            echo "CI workflow did not succeed (conclusion: ${{ github.event.workflow_run.conclusion }})"
            echo "should_publish=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if this was a push event (not PR)
          if [[ "${{ github.event.workflow_run.event }}" != "push" ]]; then
            echo "CI workflow was not triggered by push event (event: ${{ github.event.workflow_run.event }})"
            echo "should_publish=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if this is a fork and if we should skip upstream main publishes
          IS_FORK="${{ github.repository != github.event.workflow_run.repository.full_name }}"
          IS_MAIN_BRANCH="${{ github.event.workflow_run.head_branch == 'main' }}"
          IS_TAG="${{ startsWith(github.event.workflow_run.head_branch, 'refs/tags/') }}"
          ENABLE_MAIN_PUBLISH="${{ env.ENABLE_UPSTREAM_MAIN_PUBLISH }}"
          
          SHOULD_PUBLISH="true"
          
          # If this is a fork and main branch publish is disabled, skip main branch (but allow tags)
          if [[ "$IS_FORK" == "true" ]] && [[ "$IS_MAIN_BRANCH" == "true" ]] && [[ "$IS_TAG" == "false" ]] && [[ "$ENABLE_MAIN_PUBLISH" == "false" ]]; then
            echo "Fork detected with main branch publish disabled - skipping"
            SHOULD_PUBLISH="false"
          fi
          
          echo "should_publish=$SHOULD_PUBLISH" >> $GITHUB_OUTPUT
          echo "Final decision: should_publish=$SHOULD_PUBLISH"

  merge:
    runs-on: ubuntu-latest
    needs: [check-ci-success]
    if: needs.check-ci-success.outputs.should_publish == 'true'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0 https://github.com/actions/checkout/releases/tag/v6.0.0

      - uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1 https://github.com/docker/setup-buildx-action/releases/tag/v3.11.1

      # Download digest artifacts created by ci-docker.yml
      # These reference images already pushed to GHCR by digest
      - name: Download digests
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: ${{ runner.temp }}/digests
          pattern: digests-*
          merge-multiple: true
          run-id: ${{ github.event.workflow_run.id }}  # Download from triggering CI workflow
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0 https://github.com/docker/login-action/releases/tag/v3.6.0
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}  # Set in: Settings > Secrets > DOCKER_PASSWORD

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0 https://github.com/docker/login-action/releases/tag/v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}  # Automatically provided by GitHub

      # Override GitHub context for metadata-action in workflow_run context
      # 
      # PROBLEM: workflow_run trigger causes github.ref to point to publish.yml's
      # location (refs/heads/main), not the original trigger ref (tag or branch).
      # The metadata-action reads github.ref to extract version/tag information.
      #
      # SOLUTION: Set GITHUB_REF* environment variables from workflow_run.head_branch
      # before metadata-action runs. These env vars override the context values.
      #
      # REFERENCES:
      # - metadata-action uses github.ref: https://github.com/docker/metadata-action
      # - workflow_run context: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_run
      # - Setting env vars to override context: https://docs.github.com/en/actions/learn-github-actions/variables#default-environment-variables
      - name: Set ref context from workflow_run
        run: |
          HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
          echo "Original trigger: $HEAD_BRANCH"
          
          if [[ "$HEAD_BRANCH" == refs/tags/* ]]; then
            # Tag push: refs/tags/v10.5.3-testci
            TAG_NAME="${HEAD_BRANCH#refs/tags/}"
            echo "Detected tag: $TAG_NAME"
            echo "GITHUB_REF=$HEAD_BRANCH" >> $GITHUB_ENV
            echo "GITHUB_REF_NAME=$TAG_NAME" >> $GITHUB_ENV
            echo "GITHUB_REF_TYPE=tag" >> $GITHUB_ENV
          else
            # Branch push: main
            echo "Detected branch: $HEAD_BRANCH"
            echo "GITHUB_REF=refs/heads/$HEAD_BRANCH" >> $GITHUB_ENV
            echo "GITHUB_REF_NAME=$HEAD_BRANCH" >> $GITHUB_ENV
            echo "GITHUB_REF_TYPE=branch" >> $GITHUB_ENV
          fi

      - id: meta-dockerhub
        name: Metadata - Docker Hub
        uses: docker/metadata-action@318604b99e75e41977312d83839a89be02ca4893 # v5.9.0 https://github.com/docker/metadata-action/releases/tag/v5.9.0
        with:
          images: ${{ env.DOCKER_IMAGE_NAME }}
          flavor: |
            latest=auto  # Automatically adds :latest for release tags (not prereleases)
            prefix=
            suffix=
          tags: |
            # Only version, no revision
            type=match,pattern=v(.*)-(.*),group=1
            # branch
            type=ref,event=branch
            # semver
            type=semver,pattern={{version}}

      - id: meta-ghcr
        name: Metadata - GHCR
        uses: docker/metadata-action@318604b99e75e41977312d83839a89be02ca4893 # v5.9.0 https://github.com/docker/metadata-action/releases/tag/v5.9.0
        with:
          images: ${{ env.GHCR_IMAGE_NAME }}
          flavor: |
            latest=auto  # Automatically adds :latest for release tags (not prereleases)
            prefix=
            suffix=
          tags: |
            # Only version, no revision
            type=match,pattern=v(.*)-(.*),group=1
            # branch
            type=ref,event=branch
            # semver
            type=semver,pattern={{version}}

      # Create multi-arch manifest for GHCR
      # This copies the existing digest-based images from GHCR and creates a manifest with proper tags
      # Images were already pushed to GHCR by ci-docker.yml - we're just retagging them here
      - name: Create manifest list and push to GHCR
        working-directory: ${{ runner.temp }}/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ env.GHCR_IMAGE_NAME }}@sha256:%s ' *)
        env:
          DOCKER_METADATA_OUTPUT_JSON: ${{ steps.meta-ghcr.outputs.json }}

      # Create multi-arch manifest for Docker Hub
      # This copies/mirrors images from GHCR to Docker Hub
      # The source digests are in GHCR, but the -t tags specify Docker Hub destination
      # imagetools automatically handles cross-registry copying
      - name: Create manifest list and push to Docker Hub
        working-directory: ${{ runner.temp }}/digests
        run: |
          # Build tags list from Docker Hub metadata
          TAGS=$(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON")
          
          # Build source digests list (from GHCR)
          DIGESTS=$(printf '${{ env.GHCR_IMAGE_NAME }}@sha256:%s ' *)
          
          echo "Creating Docker Hub manifest with tags: $TAGS"
          echo "Source digests from GHCR: $DIGESTS"
          
          # imagetools create copies from GHCR digests to Docker Hub with specified tags
          docker buildx imagetools create $TAGS $DIGESTS
        env:
          DOCKER_METADATA_OUTPUT_JSON: ${{ steps.meta-dockerhub.outputs.json }}

      # Verify manifests were created successfully
      - name: Inspect GHCR image
        continue-on-error: true
        run: |
          echo "Inspecting GHCR manifest:"
          docker buildx imagetools inspect ${{ env.GHCR_IMAGE_NAME }}:${{ steps.meta-ghcr.outputs.version }}

      - name: Inspect Docker Hub image
        continue-on-error: true
        run: |
          echo "Inspecting Docker Hub manifest:"
          IMAGE_REF="docker.io/${{ env.DOCKER_IMAGE_NAME }}:${{ steps.meta-dockerhub.outputs.version }}"
          echo "Image reference: $IMAGE_REF"
          if [ -n "$IMAGE_REF" ] && [ "$IMAGE_REF" != "docker.io/:" ]; then
            docker buildx imagetools inspect "$IMAGE_REF"
          else
            echo "Invalid image reference, skipping inspect"
          fi

      # Update Docker Hub from README

      # Updates Docker Hub repository description from README.md
      # Requires DOCKER_PASSWORD secret with read/write permissions
      # Note: Personal Access Tokens need "Read, Write, Delete" permissions
      - name: Docker Hub Description
        continue-on-error: true  # Don't fail workflow if description update fails
        uses: peter-evans/dockerhub-description@1b9a80c056b620d92cedb9d9b5a223409c68ddfa # v5.0.0
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}  # Set in: Settings > Secrets > DOCKER_PASSWORD
          repository: ${{ env.DOCKER_IMAGE_NAME }}
          readme-filepath: ./README.md
          short-description: "Cardano Node built from source on Debian"

  github-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: [merge]
    steps:
      - run: 'echo "RELEASE_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV'
      - uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0 https://github.com/actions/github-script/releases/tag/v8.0.0
        if: startsWith(github.ref, 'refs/tags/')
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.repos.createRelease({
                draft: false,
                generate_release_notes: true,
                name: process.env.RELEASE_TAG,
                owner: context.repo.owner,
                prerelease: ${{ (startsWith(github.ref, 'refs/tags/') && contains(github.ref, '-pre-')) && true || false }},
                repo: context.repo.repo,
                tag_name: process.env.RELEASE_TAG,
              });
            } catch (error) {
              core.setFailed(error.message);
            }
